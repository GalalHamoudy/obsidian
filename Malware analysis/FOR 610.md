### **If you need to produce a formal report, here's one way to structure it :**
- Summary of the analysis
- Identification (IOCs)
- Characteristics (consider MAEC Malware Capabilities or Malware Behavior Catalog)
- Dependencies
- Behavioral and code analysis findings
- Supporting figures
- Incident recommendations

---- [see malware analysis formal report]

**Beaconing**: Sending brief periodic messages to the adversary with basic information about the state of the malicious program and its infected host.
**Command and control (abbreviated as C2 or C&C)**: Obtaining instructions from the adversary regarding actions that the specimen needs to perform, such as upgrade itself or scan a host.
**Exfiltration**: Sending stolen data, such as keystroke logs, to the adversary.


**K> pestr file.exe       ........ like strings**
**K> peframe file.exe  ........ like peStudio**
**K> diec file.exe         ....... like detect it easy**



- Summary of the analysis: Key takeaways the reader should get from the report regarding the specimen's nature, origin, capabilities, and other relevant characteristics.
- Identification: The type of the file, its name, size, hashes (such as SHA256), malware names (if known), and current antivirus detection capabilities.
- Characteristics: The specimen's capabilities for infecting files, self-preservation, spreading, leaking data, interacting with the attacker, and so on. For a good reference of what characteristics you may need to capture, take a look at the MAEC Malware Capabilities project at https://for610.com/maec or the alternative effort Malware Behavior Catalog (MBC) at https://for610.com/mbc.
- Dependencies: Files and network resources related to the specimen's functionality, such as supported OS versions and required initialization files, custom DLLs, executables, URLs, and scripts.
- Behavioral and code analysis findings: Overview of the analyst's behavioral, as well as static and dynamic code analysis observations.
- Supporting figures: Logs, screenshots, string excerpts, function listings, and other exhibits that support the investigator's analysis.
- Incident recommendations: Indicators for detecting the specimen on other systems and networks, and possible for eradication steps.

---

[Speakeasy](https://github.com/mandiant/speakeasy) is a free, open-source emulator released by FireEye. It's "designed to emulate Windows kernel and user mode malware."
`run_speakeasy.py -t brbbot.exe -o speakeasy.json 2> speakeasy.txt`


We use **jq** tool to deal with .json file.

The Malware Behavior Catalog (MBC) is a catalog of malware objectives and behaviors, created to support malware analysis-oriented use cases, such as labeling, similarity analysis, and standardized reporting.
https://github.com/MBCProject/mbc-markdown

turn on the web server on REMnux by issuing the httpd start command in the REMnux terminal window.
turn off the web server on REMnux by issuing the httpd stop command in the REMnux terminal window.

### INetSim

**INetSim** can emulate many protocols, including HTTP, HTTPS, SMTP, FTP, POP3, TFTP, IRC, and more.

You can obtain a free copy of INetSim from https://inetsim.org. It is also installed on REMnux. Following are the REMnux locations of the important files that INetSim uses:

- /etc/inetsim/inetsim.conf is the main configuration file of INetSim. It enables you to define which services INetSim should emulate. It also enables you to define service-specific options, such as listening ports, static DNS mappings, HTTP response parameters, SSL configuration details, and so on.
- /var/log/inetsim contains the INetSim log files. The most useful of these files is probably service.log, which contains details about the requests INetSim received and the responses it provided.
- /var/lib/inetsim contains data files used by INetSim emulators, such as the files provided by the HTTP emulator or the certificate used for SSL encryption for the HTTPS emulator.

To see the details of the connection established between ghyte.exe and INetSim's HTTPS emulator, examine INetSim's log file /var/log/inetsim/service.log by issuing this command on REMnux:
`sudo more /var/log/inetsim/service.log`



### Fiddler

- [Fiddler](https://www.telerik.com/download/fiddler) can intercept and display HTTP and HTTPS traffic from the client side on Windows.
- Its powerful proxy-like debugging capabilities are also useful when assessing web applications.
- If you don't have web services active on REMnux, you can use Fiddler's autoresponder to generate HTTP and HTTPS responses.


### iptables
iptables, which is a powerful Linux-based firewall software. Its capabilities include Network Address Translation (NAT), which we can use to intercept and redirect network connections going to all possible IP addresses.

To use iptables for such interception, your Windows virtual machine needs to be configured to point to the REMnux virtual machine's IP as its default gateway.
Activate iptables redirection using: accept-all-ips start


Tools for static analysis :
- **signsrch**: Locates code used for crypto, compression, and more.
- **pescan** and portex: Examine key aspects of Windows executable files and identify some anomalies.
- **MASTIFF**: Extracts many details from various types of malware; good for bulk review of many samples.
- **exiftool**: Displays metadata embedded in files of various types.
- **trid**: Identifies the type of file you're starting to examine.
- **viper**: Manages the malware collection and extracts various static properties about the files.

---
---

# 610.5: Examining Self-Defending Malware

at x64dbg After right-clicking, select Search for > Current Region > Intermodular calls.

IsDebuggerPresent returns a non-zero value if the process is being debugged; otherwise, it returns zero
```
call qword ptr ds:[<&IsDebuggerPresent>]
test eax,eax
jne galalfun.140001216
```

Instead of calling IsDebuggerPresent, the specimen can manually check the BeingDebugged field in the PEB.
```
mov eax,fs:[30h]
mov eax,[eax+2]
test eax,eax
```

The specimen can call OutputDebugString, which returns a valid address only if it's being debugged.
Other APIs include CheckRemoteDebuggerPresent, NtQueryInformationProcess/ZwQueryInformationProcess, etc.


Malware can also check whether its process was launched by the debugger by looking at the NtGlobalFlag field in the PEB.
PEB's NtGlobalFlag is normally zero, but it contains specific flags (0x70) when the process was launched by the debugger:
```
▫ FLG_HEAP_ENABLE_TAIL_CHECK (0x10)
▫ FLG_HEAP_ENABLE_FREE_CHECK (0x20)
▫ FLG_HEAP_VALIDATE_PARAMETERS (0x40)
```
NtGlobalFlag is at offset 0x68 in the PEB of 32-bit processes and at 0xBC in the PEB of 64-bit processes.

Malware can also check whether its process was launched by the debugger by looking at the NtGlobalFlag field in the PEB.
```
mov eax,dword ptr fs:[30]
test byte ptr ds:[eax+68],70
```


Malware can detect via GetTickCount that it's being debugged if it's executing too slowly due to single-stepping.
Other approaches to detecting the debugger involve the specimen timing its execution.
```
if ((GetTickCount() - lStartTime) > 5000) {
g_pMainCtrl->m_cConsDbg.Log(5,"Routine took too long to execute, probably single-step...\n");
m_bIsDebug=true;
return true;
```

Other API calls include GetLocalTime, GetSystemTime, etc.
The assembly instruction **RDTSC** can be similarly used.


**XORSearch** can spot and decode strings encoded using this and several other common algorithms.
Use the "-i" parameter for case-insensitive searches.
Use "-s" to generate a file that decodes all bytes in the original file using the discovered key to try finding additional strings.

```
xorsearch -i -s getdown. exe http:
> Found XOR 83 position 8ECO: http://1.234.27.146/pcfix.exe
strings getdown.exe.XOR.83 | more
```


Use brxor.py to deobfuscate XOR-encoded strings that include English words without having to specify any substrings.
`brxor.py hi.dll`
The brxor.py tool was created by Trenton Tait on the basis of Alexander Hanel's brutexor.py tool.


The bbcrack utility can automatically identify patterns within the file that might need to be decoded using basic
algorithms based on XOR, ROL, and ADD, as well as the combined use of these algorithms (for example, XOR and
ADD). Moreover, bbcrack can attempt to guess the obfuscation key.

`bbcrack -l 1 hubert.dll`
The "-l 1" parameter to bbcrack directs the tool to attempt only one level of transformations, rather than look for
combinations of the algorithms the tool supports.

As you can see on this slide, the tool automatically determines several potential XOR keys, and generates files that
use those keys to deobfuscate contents. One of these files, hubert_xor05.dll, contains meaningful contents in our
example, as you can see by running:
`strings hubert_xor05.dll | more`

It is possible to automatically reconstruct the strings that malware authors obfuscate.
The tool strdeob.pl, installed on REMnux, can accomplish this. It was originally released by Team Cymru but is no longer available on its website.
The tool disassembles the designated malicious executable and then looks for MOV instructions that operate on a single byte value to dynamically build a string. 
This tool succeeds at decoding the content that we've deobfuscated using Ghidra earlier. It also shows additional strings concealed within the malicious program. Keep in mind that the strdeob.pl script will not locate strings obfuscated using other techniques.

`strdeob.pl 9.exe`



NtAllocateVirtualMemory, ZwProtectVirtualMemory, and ZwWriteVirtualMemory could be used for code injection.
RtlDecompressBuffer decompresses data in a buffer and could be used for deobfuscation or unpacking.


Exceptions are an error condition, which the code can usually handle.
Malware can use them to confuse analysts, as we'll learn a bit later.
• Go to Options > Preferences > Exceptions.
• Select the filter 00000000-FFFFFFFF, then click "Do not break".
• x32dbg/x64dbg seems to "forget" this setting when you exit.

RtlDecompressBuffer saves decoded contents to the memory address supplied as the UncompressedBuffer argument.
• It expects to receive UncompressedBuffer as the second argument.

