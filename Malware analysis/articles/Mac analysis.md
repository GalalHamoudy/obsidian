### Core Concepts of macOS Malware

*   **File Formats:** The primary formats are **Mach-O** (the equivalent of PE/ELF) and **Apple Universal Binaries** (which can contain multiple Mach-O architectures).
*   **Persistence:** Common mechanisms include Launch Agents/Daemons (`plist` files in `~/Library/LaunchAgents/` or `/Library/LaunchDaemons/`), Login Items, Cron jobs, and Browser Extensions.
*   **Execution Chain:** Modern macOS malware often uses multi-stage payloads, leveraging scripts (bash, Python, AppleScript) or exploiting legitimate macOS tools (like `osascript` or `xattr`) to bypass security.

---

### Analysis Toolkit (Using Windows/Linux)

Your goal is to perform as much **static analysis** as possible from your primary OS, reserving **dynamic analysis** for a controlled macOS environment (or cloud-based Mac sandbox).

#### **Phase 1: Initial Triage & Static Analysis (Cross-Platform)**

**Goal:** Identify the file type, extract strings, and look for low-hanging fruit.

1.  **`file` Command (Linux/WSL):** Your first step. It brilliantly identifies Mach-O files and their architecture.
    *   `file malware.zip`
    *   *Output examples:*
        *   `Malware: Mach-O 64-bit executable x86_64` (Intel Mac)
        *   `Malware: Mach-O 64-bit executable arm64` (Apple Silicon Mac)
        *   `Malware: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64:Mach-O 64-bit executable arm64]` (Universal Binary)

2.  **`strings` Command (Linux/WSL):** As always, critical. Look for:
    *   **Paths:** `/Applications`, `/Library`, `~/Library`, `.app/Contents/MacOS/`
    *   **Commands:** `osascript`, `curl`, `bash -c`, `xattr -d com.apple.quarantine` (used to remove quarantine attributes)
    *   **Persistence:** `LaunchAgents`, `LaunchDaemons`, `.plist`
    *   **C2 Servers:** URLs and IP addresses.

3.  **Extract Archives:** macOS malware is often distributed in `.zip`, `.dmg` (Disk Image), or `.pkg` (Installer) files.
    *   **`.dmg` files:** Can be mounted on Linux with `dmg2img` or `7-zip` (on Windows) can often extract their contents.
    *   **`.pkg` files:** These are actually `.xar` archives. Extract them on Linux with `xar -xf malware.pkg`. You'll then find sub-packages (`.pkg` files) and distribution scripts.
    *   **`.app` bundles:** These are actually directories. Rename `Malware.app` to `Malware.app.zip` and unzip it, or browse its structure with your file manager. The executable is in `Malware.app/Contents/MacOS/`.

#### **Phase 2: Advanced Static Analysis (Cross-Platform)**

**Goal:** Deeper inspection of the Mach-O binary.

1.  **`otool` (Linux via `darling-otool` or Mac-only):** The native macOS tool for Mach-O analysis. If you can't run it, focus on Ghidra.
    *   *Key commands (if available):*
        *   `otool -L malware` (Lists linked libraries - like `ldd` on Linux)
        *   `otool -hv malware` (Shows Mach-O header)
        *   `otool -tV malware` (Disassembles the `__text` section)

2.  **Ghidra (Windows/Linux/macOS):** **Your most important tool.** It has excellent support for Mach-O binaries and both x86_64 and ARM64 (Apple Silicon) architectures.
    *   Load the Mach-O file into Ghidra.
    *   Let it analyze. Look for the `main` function.
    *   **Key macOS APIs to look for in the decompiler:**
        *   **File System:** `NSFileManager`, `fopen`, `copyfile`
        *   **Network:** `NSURLConnection`, `CFNetwork`, `socket`
        *   **Persistence:** `SMLoginItemSetEnabled`, `AuthorizationExecuteWithPrivileges` (deprecated but still used), calls to write `plist` files.
        *   **Process Execution:** `NSTask`, `posix_spawn`, `system`
        *   **Anti-Analysis:** `ptrace` (with `PT_DENY_ATTACH`), `sysctl` (to check for a debugger presence).

3.  **`jtool2` (Linux/macOS):** A powerful third-party tool by Jonathan Levin, author of *Mac OS X and iOS Internals*. It's like a supercharged `otool` and can decode many macOS-specific structures.
    *   `jtool2 -L malware` (List libraries, more verbose than `otool`)
    *   `jtool2 -S malware` (Display symbols)
    *   `jtool2 -d __TEXT.__cstring malware` (Dump the cstring section)
    *   `jtool2 --sig malware` (Display code signing information - very important!)

4.  **Code Signing Inspection:** Code signing is a key macOS security feature. Malware may be ad-hoc signed (no identity) or have a forged signature.
    *   **`codesign` tool (Mac-only):** The best way: `codesign -dv --verbose=4 malware`
    *   **Cross-Platform:** Use Ghidra or `jtool2` to look at the `__LINKEDIT` segment which contains the signature.

#### **Phase 3: Dynamic Analysis (Requires macOS)**

**This is the hardest part without a physical Mac.** Your options are:

1.  **Automated Sandboxes (Best Option without a Mac Lab):**
    *   **Objective-See's VirusTotal Uploader:** Upload the sample and it will run it on a real Mac sandbox, providing a detailed report of all file, process, and network activity.
    *   **Hybrid Analysis / ANY.RUN:** These platforms often have macOS VMs and will provide behavioral reports.

2.  **Build a Dedicated Mac VM (Ideal for Analysts):**
    *   Use virtualization software like **VMware Fusion** (on a Mac host) or **Parallels**. Apple's licensing restricts virtualizing macOS on non-Apple hardware, making a real Mac the only fully legal/supported path.
    *   **Crucial Tool: Objective-See's Tools (Free & Excellent):**
        *   **Process Monitor:** (`procmon`) Monitors all process events.
        *   **File Monitor:** (`fsmon`) Monitors all file system events.
        *   **BlockBlock:** Monitors for persistence attempts (Launch Agents, etc.).
        *   **KnockKnock:** Scans for persistent components.
        *   **LuLu:** A free firewall to block outgoing connections and discover C2 servers.
        *   **RansomWhere?:** Monitors for file encryption patterns.
    *   **System Logs:** Use the `console` app to view unified logs. Filter for your process name.

### Important Tips for macOS Malware Analysis

*   **Start with `file` and `strings`.** This immediately tells you the target architecture and often reveals C2 servers or scripts.
*   **Beware of Scripts:** A huge amount of macOS malware is script-based (bash, Python, AppleScript). These are often easier to analyze statically.
*   **`.pkg` Installers are Complex:** They contain pre-install and post-install scripts. Always extract the `.pkg` and examine these scriptsâ€”they contain the malicious logic.
*   **Look for Quarantine Bypass:** Malware often uses `xattr -d com.apple.quarantine` to remove the "downloaded from the internet" warning before execution.
*   **Check for Notarization:** Modern malware may be notarized by Apple (by abusing the program). Check the notarization ticket with `spctl` or in the code signature.
*   **Apple Silicon (ARM64) is the Future:** Ensure your tools (especially Ghidra) can handle the ARM64 instruction set.

**Summary Workflow (from Windows/Linux):**
1.  **Triage:** Use `file` and `strings` on the downloaded file (`.dmg`, `.zip`, `.pkg`).
2.  **Extract:** Unpack the archive and locate the primary Mach-O executable or script.
3.  **Static Analysis:** Load the Mach-O file into **Ghidra**. Analyze the `main` function and look for macOS-specific API calls.
4.  **Script Analysis:** If it's a script, read it directly. It's plain text.
5.  **Sandbox Detonation:** Upload the sample to an automated sandbox like **Objective-See's VT Uploader** or **Hybrid Analysis** to get a behavioral report.
6.  **IOC Extraction:** From all the above, extract hashes, C2 servers, file paths, and persistence mechanisms.

While dynamic analysis is challenging without a Mac, a skilled analyst can uncover 90% of the malware's functionality through careful static analysis with cross-platform tools like Ghidra.