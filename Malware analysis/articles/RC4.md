RC4 (also known as Rivest Cipher 4) is a form of stream cipher and variable-length key algorithm. It encrypts messages one byte at a time, what makes RC4 popular is how simple it is to apply it and that it is high-speed algorithm even on a really large pieces of data and it is just a few lines of code and that’s simply why it has been used by many malware authors. Additionally, it is similar to the [one-time pad](https://en.wikipedia.org/wiki/One-time_pad "One-time pad"), except that generated pseudorandom bits, rather than a prepared stream, are used.

RC4 uses a pseudorandom bit generator that produces a stream 8-bit number that is unpredictable without knowledge of the input key, the output of the generator is called key-stream, and is combined one byte at a time with the plaintext stream cipher using X-OR operation.

> Note that RC4 use has been banned by the Internet Engineering Task Force because it’s not a strong algorithm and multiple vulnerabilities have been found in it, rendering it insecure.


RC4 algorithm consist of 3 stages:

KSA (Key Scheduling Algorithm):
which initalizes the process in an array typically referred to as `S-box`. That `S-box` is processed 256 times, and bytes from the key are mixed in too.

```python
def KSA(key):  
SBox = list(range(0,256)) # Initialize SBox with 256 values  
j = 0  
for i in range (0,256):  
j = (j + SBox[i] + key[i % len(key)]) % 256 #SBox is scrambled with key  
SBox[i],SBox[j] = SBox[j],SBox[i] #Swap SBox[i] and SBox[j]  
return SBox
```

PRGA (Pseudo Random Generation Algorithm):
where data is fed byte by byte and a mathematical model modifies it. The model looks up values and adds them to 256, and uses the sum as the byte within the keystream (a [stream](https://en.wikipedia.org/wiki/Stream_\(computing\) "Stream (computing)") of [random](https://en.wikipedia.org/wiki/Randomness "Randomness") or [pseudorandom](https://en.wikipedia.org/wiki/Pseudorandomness "Pseudorandomness") characters that are combined with a [plaintext](https://en.wikipedia.org/wiki/Plaintext "Plaintext") message to produce an encrypted message). It swaps each element with another at least once every 256 rounds.

The key generation algorithm used uses a variable-light key from 1 to 256 bytes to initialize a 256-byte state vector S, with elements S[0] to S[255].

For encryption and decryption a byte K is generated from S by selecting one of the 255 entries in a systematic fashion, then the entries in S are permuted (Swapped with each other) again.

```python
def PRGA(SBox):  
i = 0  
j = 0  
while True:  
i = (i + 1) % 256  
j = (j + SBox[i]) % 256  
SBox[i],SBox[j] = SBox[j],SBox[i] #Swap SBox[i] and SBox[j]  
yield SBox[(SBox[i] + SBox[j]) % 256] #Returns key stream generator
```

XOR:
```python
def XOR(keyStream):  
bufferCipher = ''  
for c in plainText:  
bufferCipher += "%02X" % (ord(c) ^ next(keyStream)) #XOR each byte of key stream with each byte of plaintext/cipher  
return bufferCipher
```

The main function of the code is shown below.

```python
key = [ord(c) for c in "SecretKey"]  
plainText = 'C2 Network Communications'  
cipherText = ''  
  
SBox = KSA(key)  
keyStream = PRGA(SBox)  
cipherText = XOR(keyStream)  
print(cipherText)
```


**Indicator:**

The RC4 algorithm flow is easy to recognize.
- The loops for 256 iterations are dead giveaway of RC4.

**Note:** Tools like CAPA and KANAL can help to identify the possible cryptographic algorithm used in the sample.


